# 实验五 多表数据查询与视图
## 实验目的
- 掌握左（右）连接查询的方法与目的
- 掌握复合条件查询的命令
- 掌握嵌套查询基本命令以及相关运算符的用法
- 掌握创建视图的基本方法
- 熟悉利用视图完成复杂查询的基本方法
- 掌握更新视图的限制条件

## 实验准备
1. 将实验3的数据插入在数据库相应表中
2. 创建奖学金表scholarship

|字段名|数据类型|完整性约束条件|说明|
|--|--|--|--|
|ssno| int| 主键|自增|
|ssclass|char(6)|非空|等级|
|score|float|非空，唯一|分数|

3. 将以下数据插入奖学金表中

|编号|奖学金等级|成绩|
|--|--|--|
|1|first| 90|
|2|second|85|
|3|third|80|

## 实验步骤
1. 利用学生信息表左连接查询成绩表所有信息
2. 利用成绩表右连接查询课程信息表所有信息
3. 利用复合条件(完全连接)查询tom的数学成绩
4. 利用嵌套查询，查询单门成绩取得一等奖学生的所有信息
5. 查找数学课成绩不低于操作系统课程的最低成绩的学生的学号
6. 查找选修数据库课程的学生的姓名
7. 创建视图view_1，视图包含学生的全部信息
8. 创建视图view_2，视图包含每门课程的课程号、课程名和课程平均分
9. 更新视图view_2数据，更改课程名为数学的平均成绩为90分
10. 创建视图view_3，由view_2视图导出的信息，包含课程名和课程平均分
11. 更新视图view_3数据，更改课程名为数学的平均成绩为90分
12. 创建视图view_4，视图包含学生的学号、姓名和地址信息
13. 向view_4插入一条记录（学号为2018009的lily的家在usa）
14. 创建视图view_5，视图包含学生姓名，地址，课程名和成绩
15. 利用视图view_5，查询中国学生的平均成绩
16. 利用视图view_5，查询学生平均分成绩取得一等奖学生的姓名和平均成绩

## 学生提问
1. 找出每个学生超过他选修课程平均成绩的课程号   （张跃）
2. 如何针对多个表创建视图，使用视图查询多个表时如何消除重复数据   （陶新兰）
3. 查询高于数学平均分的同学的姓名和学号 （郑鹏）
4. 按平均成绩从高到低显示所有学生的所有课程的成绩以及平均成绩 （张优优）
5. 查询"c001"课程比"c002"课程成绩低的学生的信息及课程分数
6. 检索"c001"课程分数小于90，按分数降序排列的学生信息
7. 查询两门及其以上不及格课程的同学的学号，姓名及其平均成绩  （杨丹凤）
8. 
|cm_id | count|
|--|--|
|x|20|
|y|30|
|y|40|
|x|60|

上面可以看到cm_id为x的count字段的和是80，比y的高10。那x的排名应该是1,y 的排名是2。应该怎么用sql语句查出来呢？（李森）

## 实验代码
1. 利用学生信息表左连接查询成绩表所有信息
```sql
select * from student left join sc on student.sno=sc.sno;
```

2. 利用成绩表右连接查询课程信息表所有信息
```sql
select * from sc right join course on sc.cno=course.cno;
```

3. 利用复合条件(完全连接)查询tom的数学成绩
```sql
select grade from sc,student as s,course as c 
    where sc.sno=s.sno and sc.cno=c.cno and s.sname='tom' and c.cname='math';
```

4. 利用嵌套查询，查询单门成绩取得一等奖学生的所有信息
```sql
select * from student 
    where sno in 
        (select sno from sc where grade >= 
            (select score from scholarship where ssclass='first')
        );
```

5. 查找数学课成绩不低于操作系统课程的最低成绩的学生的学号
```sql
select sno from sc 
    where sc.cno=(select cno from course where cname='math')
    and sc.grade >= any(select grade from sc where cno=(select cno from course where cname='os'));
```

6. 查找选修数据库课程的学生的姓名
```sql
select sname from student where sno in
    (select sno from sc where cno=(select cno from course where cname='db'));
```

7. 创建视图，视图包含学生的全部信息
```sql
create view view_1 as 
    select * from student;

select * from view_1;
```

8. 创建视图view_2，视图包含每门课程的课程号、课程名和课程平均分
```sql
create view view_2(course_no,course_name,average) as
    select c.cno,c.cname,avg(sc.grade) from course as c,sc where sc.cno=c.cno group by sc.cno;
```

9. 更新视图view_2数据，更改课程名为数学的平均成绩为90分
```sql
update view_2 set average=90 where course_no = (select cno from course where cname='math');
```

10. 创建视图view_3，由view_2视图导出的信息，包含课程名和课程平均分
```sql
create view view_3 as select (course_name,average) from view_2;
```

11. 更新视图view_3数据，更改课程名为数学的平均成绩为90分
```sql
update view_3 set average=90 where course_no = (select cno from course where cname='math');
```

12. 创建视图view_4，视图包含学生的学号、姓名和地址信息
```sql
create view view_4 as select sno,sname,saddr from student;
```

13. 向view_4插入一条记录（学号为2018009的lily的家在usa）
```sql
insert into view_4 values('2018009','lily','usa');
```

14. 创建视图view_5，视图包含学生姓名，地址，课程名和成绩
```sql
create  view view_5(stuname,address,coursename,score)
    as select s.sname,s.saddress,c.cname,sc.grade from student as s,course as c,sc 
        where sc.cno=c.cno and sc.sno=s.sno;
```

15. 利用视图view_5，查询中国学生的平均成绩
```sql
select avg(score) from view_5 group by address having address='chn'; 
```

16. 利用视图view_5，查询学生平均分成绩取得一等奖学生的姓名和平均成绩
```sql
create view view_6(stuname,avg_score) 
    as select stuname,avg(score) from view_5 group by stuname;

select stuname,avg_score from view_6
    where avg_score >= (select score from scholarship where ssclass='first'); 
```

## 学生提问的代码
1. 找出每个学生超过他选修课程平均成绩的课程号 
```
create view v_1(sno,avg) 
    as select sno,avg(grade) from sc group by sno;

select * from v_1;

select cno,sno from sc,v_1 
    where grade >= (select avg from v_1 where sc.sno=v_1.sno);
```

2. 如何针对多个表创建视图，使用视图查询多个表时如何消除重复数据
```
create view v_2(sname,cname,grade)
    as select sname,cname,grade from student as s,course as c,sc 
        where s.sno=sc.sno and c.cno=course.cno;

select * from v_2;

select distinct(sname) from v_2;
```

3. 查询高于数学平均分的同学的姓名和学号
```
Create view v_3(cno, avg)
	as select cno,avg(grade) from sc group by cno;

Select sname,sno from student as s,sc
	where sc.grade >= (select avg from v_3 where cno=(select cno from course where cname=‘math’)) 
        and c.sno=sc.sno 
        and sc.cno=(select cno from course where cname=‘math’);
```

4. 按平均成绩从高到低显示所有学生的所有课程的成绩以及平均成绩
```
create view v_4(sno,avg)
    as select sno,avg(grade) from sc group by sno;

select sc.sno,sc.cno,v_4.avg from sc,v_4 
    where v_4.sno=sc.sno order by avg desc;

select s.sname,c.cname,sc.grade,v_4.avg from sc,v_4,student as s,course as c
    where v_4.sno=sc.sno and s.sno=sc.sno and c.cno=sc.cno 
    order by avg desc;
```

5. 查询"c001"课程比"c002"课程成绩低的学生的信息及课程分数(夏红军)
```
create view v1(sno,c001,grade) as select sno,cno,grade from sc where cno='c001';  
create view v2(sno,c002,grade) as select sno,cno,grade from sc where cno='c002';
select * from v1,v2 where v1.sno=v2.sno and v1.grade > v2.grade;
```
6. 检索"c001"课程分数小于90，按分数降序排列的学生信息(郑鹏)
```
create view v_10(xuehao,name,kecheng,chengji) as select s.sno,s.sname,c.cno,sc.grade from student as s,coures as c,sc where sc.cno=c.cno and sc.sno=s.sno and c.cno='c001';
select * from v_10 where chengji<90 order by chengji desc; 
```
7. 查询两门及其以上不及格课程的同学的学号，姓名及其平均成绩
```
Create view v_7(xuehao,fenshu)
 as select sno,grade from sc where grade<60;
Create view v_8(xuehao,kechenshu)
As select xuehao,count(*) from v_7 group by xuehao;
Create v_9(xuehao,xingming,chengji) as 
Select s.sno,s.sname,sc.grade from student as s,sc,v_8 where s.sno=v_8.xuehao and v_8.kechengshu>=2 and s.sno=sc.sno; 
Select xuehao,xingming,avg(chengji) from v_9 group by xuehao;
```