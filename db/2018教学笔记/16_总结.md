# 课程总结
## 从“一条SQL查询语句是如何执行的”开始
- MySQL基本架构
- Server层和存储引擎层
- 连接器
- 查询缓存
- 分析器
- 优化器
- 执行器

### MySQL基本架构
查询语句如下：
```sql
select * from T where ID=10;
```

MySQL基本架构示意图，通过此示意图，可以清楚地看到SQL语句在MySQL的各个功能模块中的执行过程。
![](https://images.gitee.com/uploads/images/2018/1210/144756_584bba0e_1572284.jpeg "1544424425951.jpg")

### Server层和存储引擎层
首先，MySQL可以分为Server层和存储引擎层两部分。

Server层包括连接器、查询缓存、分析器、优化器、执行器等，涵盖MySQL的大多数核心服务功能，以及所有的内置函数，所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图等。

存储引擎层负责数据的存储和提取。其架构是插件式的，支持InnoDB、MyISAM、Memory等多个存储引擎。不同的存储引擎共用一个Server层，也就是从连接器到执行器的部分。

### 连接器
第一步，用户首先连接到这个数据库上，连接器负责跟用户端建立连接、获取权限、维持和管理连接。连接命令如下：
```sql
mysql -h$ip -P$port -u$user -p
```

连接命令的中的mysql是客户端工具，用来跟服务端建立连接。在完成经典的TCP握手后（三次握手），连接器开始认证身份：
- 如果用户名和密码不对，就会收到"Access denies for user"的错误，然后客户端程序结束执行。
- 如果用户名和密码认证通过，连接器会到权限表里查询该用户拥有的权限。之后，这个连接里的权限判断逻辑，都将依赖于此时读到的权限。

连接完成后，用户如果没有后续的动作，这个连接就处于空闲状态，可以利用"show processlist"命令进行观察。如下所示，其中Command列显示为"sleep"的这一行，就表示现在系统里有一个空闲连接。
![](https://images.gitee.com/uploads/images/2018/1210/150416_a1f82019_1572284.jpeg "1544425427335.jpg")

客户端如果太长时间没有动静，连接器就会自动断开此连接，这个时间由参数wait_timeout控制，默认值是8小时。

数据库里，长连接是指连接成功后，如果客户端持续有请求，则一直使用同一个连接。短连接则是指每次执行完很少的几次查询就断开连接，下次查询再重新建立连接。

如果客户端全部使用长连接，有时会导致MySQL占用内存涨得特别快，这是因为MySQL在执行过程中临时使用的内存是管理在连接对象里的。这些资源会在连接断开的时候才释放。所以如果长连接大量累积，可能导致内存占用太大，被系统强行杀掉(OOM)，从而会导致MySQL异常重启。


### 查询缓存
连接建立完成后，就开始执行select语句，执行逻辑开始第二步：查询缓存。

MySQL拿到一个查询请求后，会首先遍历查询缓存，检查之前是否执行过此条语句。之前执行的语句及结果以key-value的形式，被直接缓存在内存中。key是查询的语句，value是查询的结果。如果能够在缓存中命中key，则将对应的value值直接返回给客户端。

如果语句不在查询缓存中，就会继续后面的执行阶段。执行完成后，执行结果会被存入查询缓存中。

查询缓存往往弊大于利。因此查询缓存的失效非常频繁，只要有对一个表的更新操作，这个表上所有的查询缓存都会被清空。对于更新频繁的数据库来说，查询缓存的命中率非常低。查询缓存适合静态表（如系统配置表）的查询，因为很长时间才做一次更新操作。

MySQL提供一种按需使用的方法，可以将参数query_cache_type设置成DEMAND，这样对于默认的SQL语句都不使用查询缓存。而对于确定要使用查询缓存的语句，可以用SQL_CACHE显示指定，命令如下：
```sql
select SQL_CACHE * from T where ID=10;
```

### 分析器
如果没有命中查询缓存，就开始真正执行查询语句。MySQL需要通过分析器对命令进行解析。

首先，分析器会做"词法分析"。客户端输入的命令由多个字符串和空格组成的一条SQL语句，MySQL需要识别出里面的字符串分别是什么，代表什么。

MySQL从输入的"select"这个关键字识别出这是一条查询语句。同时要把字符串"T"识别成"表名T"，把字符串"ID"识别成"列ID"。

此次，分析器要做"语法分析"。根据词法分析的结果，语法分析器会根据语法规则，判断输入的SQL语句是否符合MySQL语法。如果语句不正确，则会返回"You have an error in your SQL syntax"的错误提示。

### 优化器
结果分析器，MySQL就知道SQL语句需要执行的指令。在开始执行之前，还需要经过优化器的处理。

优化器是在表里有多个索引时，决定使用哪个索引；或者在一个语句有多表关联(join)的时候，决定各个表的链接顺序，举例如下：
```sql
select * from t1 join t2 using(ID) where t1.c=10 and t2.d=20;
```

- 既可以先从表t1里面取出c=10的记录的ID值，再根据ID值关联到表t2，再判断t2里面d的值是否等于20；
- 也可以先从表t2里面取出d=20的记录的ID值，再根据ID值关联到表t1，再判断t1里面c的值是否等于10。

这两种执行方法的逻辑结果是一样的，但是执行的效率会有不同，而优化器的作用就是决定使用哪一种方案。

### 执行器
MySQL通过分析器知道了要做什么(what)，通过优化器知道了该怎么做(how)，于是就进入了执行器阶段，开始执行语句。

开始执行的时候，要先判断一下用户对表T有没有执行查询的权限，如果没有，就会返回没有权限的错误。

如果有权限，就会打开表继续执行。打开表的时候，执行器会根据表的引擎定义，去使用这个引擎提供的接口。

比如在开始的示例中，表T的ID字段没有索引，那么执行流程如下：
1. 调用InnoDB引擎接口取这个表的第一行，判断ID值是不是10，如果不是则跳过，如果是则将这行存在结果集中；
2. 调用引起接口取"下一行"，重复相同的判断逻辑，直到取到这个表的最后一行；
3. 执行器将上述遍历过程中所有满足条件的行组成的记录集作为结果返回给客户端。

至此，这个语句就执行完成了。对于有索引的表，执行逻辑类似。

## 最后的话（文末有彩蛋）
![](https://images.gitee.com/uploads/images/2018/1211/161035_763b331d_1572284.jpeg "1.webp.jpg")
![](https://images.gitee.com/uploads/images/2018/1211/161044_975e6e2c_1572284.jpeg "2.webp.jpg")
![](https://images.gitee.com/uploads/images/2018/1211/161050_f9350efe_1572284.jpeg "3.webp.jpg")
![](https://images.gitee.com/uploads/images/2018/1211/161057_0dd56ea4_1572284.jpeg "4.webp.jpg")
![](https://images.gitee.com/uploads/images/2018/1211/161103_150bff84_1572284.jpeg "5.webp.jpg")
![](https://images.gitee.com/uploads/images/2018/1211/161110_b5080c38_1572284.jpeg "6.webp.jpg")
![](https://images.gitee.com/uploads/images/2018/1211/161118_319bd4d5_1572284.jpeg "7.webp.jpg")
![](https://images.gitee.com/uploads/images/2018/1211/161125_ee2e03b7_1572284.jpeg "8.webp.jpg")
![](https://images.gitee.com/uploads/images/2018/1211/161131_7206a62f_1572284.jpeg "9.webp.jpg")
![](https://images.gitee.com/uploads/images/2018/1211/161139_8833249d_1572284.jpeg "a.webp.jpg")
![](https://images.gitee.com/uploads/images/2018/1211/161146_f66aa0e0_1572284.jpeg "b.webp.jpg")
![](https://images.gitee.com/uploads/images/2018/1211/161153_3d9aad93_1572284.jpeg "c.webp.jpg")
![](https://images.gitee.com/uploads/images/2018/1211/161203_7a1bc413_1572284.jpeg "d.webp.jpg")
![](https://images.gitee.com/uploads/images/2018/1211/161210_fdfa27ad_1572284.jpeg "e.webp.jpg")
![](https://images.gitee.com/uploads/images/2018/1211/161219_fc710eb2_1572284.jpeg "f.webp.jpg")
![](https://images.gitee.com/uploads/images/2018/1211/161231_5aa4f68a_1572284.jpeg "g.webp.jpg")
![](https://images.gitee.com/uploads/images/2018/1211/161240_750922cb_1572284.jpeg "h.webp.jpg")
![](https://images.gitee.com/uploads/images/2018/1211/161248_c29379df_1572284.jpeg "i.webp.jpg")
![](https://images.gitee.com/uploads/images/2018/1211/161256_1d756616_1572284.jpeg "j.webp.jpg")

## 数据库知识点
# 数据库设计
- 数据管理的三个阶段
- 数据库概念
- 数据库系统结构图
- 三个世界：客观世界、信息世界、计算机世界
- ER图
- 三个数据模型：层次模型、网状模型、关系型模型
- 完整性约束三个条件
- 三范式

# SQL
- 数据库：创建、查看、使用、备份、还原、删除
- 表：创建、修改、删除
- 数据：增、删、改、查
  - 单表查询
  - 多表查询
- 视图
  - 不能更新视图的条件
  - 复杂查询
- 索引
  - 创建索引
  - 索引设计的原则
- 权限：创建用户、授权、收权
- 触发器
- 存储过程、存储函数

# 谢谢大家！
